name: Build and Release Extension

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      HAS_CWS: ${{ secrets.CWS_EXTENSION_ID != '' && 'true' || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get version from manifest
        id: get_version
        run: |
          VERSION=$(grep -oP '"version":\s*"\K[^"]+' manifest.json)
          echo "VERSION=v${VERSION}" >> $GITHUB_OUTPUT

          # Vérifier si la version a changé par rapport au commit précédent
          PREV_VERSION=$(git show HEAD~1:manifest.json 2>/dev/null | grep -oP '"version":\s*"\K[^"]+' || echo "")
          if [ "$VERSION" != "$PREV_VERSION" ]; then
            echo "VERSION_CHANGED=true" >> $GITHUB_OUTPUT
          else
            echo "VERSION_CHANGED=false" >> $GITHUB_OUTPUT
          fi

      - name: Create extension ZIP
        run: |
          mkdir -p build

          cp -r manifest.json build/
          cp -r background build/
          cp -r content build/
          cp -r lib build/
          cp -r popup build/
          cp -r options build/
          cp -r assets build/
          cp -r _locales build/

          rm -f build/assets/generate-icons.html 2>/dev/null || true

          # Retirer la clé "key" du manifest (réservée au dev local, le Store assigne son propre ID)
          python3 -c "
          import json
          with open('build/manifest.json') as f: m = json.load(f)
          m.pop('key', None)
          with open('build/manifest.json', 'w') as f: json.dump(m, f, indent=2, ensure_ascii=False)
          "

          cd build
          zip -r ../anef-status-tracker-${{ steps.get_version.outputs.VERSION }}.zip .
          cd ..

      - name: Delete existing release
        run: |
          gh release delete ${{ steps.get_version.outputs.VERSION }} --yes 2>/dev/null || true
          git push origin :refs/tags/${{ steps.get_version.outputs.VERSION }} 2>/dev/null || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: ANEF Status Tracker ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Chrome Web Store

            [![Chrome Web Store](https://img.shields.io/chrome-web-store/v/icnpklneeaiffilemaflccdejefpehek?label=Chrome%20Web%20Store&logo=googlechrome&logoColor=white&color=4285F4)](https://chromewebstore.google.com/detail/anef-status-tracker/icnpklneeaiffilemaflccdejefpehek)

            **[Installer depuis le Chrome Web Store](https://chromewebstore.google.com/detail/anef-status-tracker/icnpklneeaiffilemaflccdejefpehek)** — installation en un clic, mises à jour automatiques.

            ## Installation manuelle

            1. Téléchargez le fichier ZIP ci-dessous
            2. Décompressez dans un **dossier permanent** (ex: `C:\Extensions\anef-tracker\`)
            3. Ouvrez Chrome → `chrome://extensions`
            4. Activez le **Mode développeur** (en haut à droite)
            5. Cliquez sur **"Charger l'extension non empaquetée"**
            6. Sélectionnez le dossier décompressé
          files: |
            anef-status-tracker-${{ steps.get_version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── Publication Chrome Web Store ──
      - name: Publish to Chrome Web Store
        if: ${{ env.HAS_CWS == 'true' && steps.get_version.outputs.VERSION_CHANGED == 'true' }}
        env:
          CWS_EXT_ID: ${{ secrets.CWS_EXTENSION_ID }}
          CWS_CLIENT_ID: ${{ secrets.CWS_CLIENT_ID }}
          CWS_CLIENT_SECRET: ${{ secrets.CWS_CLIENT_SECRET }}
          CWS_REFRESH_TOKEN: ${{ secrets.CWS_REFRESH_TOKEN }}
        run: |
          # 1. Obtenir un access token
          echo "::group::Get access token"
          TOKEN_RESPONSE=$(curl -s -X POST "https://oauth2.googleapis.com/token" \
            -d "client_id=${CWS_CLIENT_ID}" \
            -d "client_secret=${CWS_CLIENT_SECRET}" \
            -d "refresh_token=${CWS_REFRESH_TOKEN}" \
            -d "grant_type=refresh_token")
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
          if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "❌ Failed to get access token:"
            echo "$TOKEN_RESPONSE" | jq .
            exit 1
          fi
          echo "✅ Access token obtained"
          echo "::endgroup::"

          # 2. Upload du ZIP
          echo "::group::Upload extension"
          ZIP_FILE="anef-status-tracker-${{ steps.get_version.outputs.VERSION }}.zip"
          UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X PUT "https://www.googleapis.com/upload/chromewebstore/v1.1/items/${CWS_EXT_ID}" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "x-goog-api-version: 2" \
            -T "$ZIP_FILE")
          HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -1)
          UPLOAD_BODY=$(echo "$UPLOAD_RESPONSE" | sed '$d')
          echo "HTTP $HTTP_CODE"
          echo "$UPLOAD_BODY" | jq . 2>/dev/null || echo "$UPLOAD_BODY"
          UPLOAD_STATUS=$(echo "$UPLOAD_BODY" | jq -r '.uploadState' 2>/dev/null)
          if [ "$UPLOAD_STATUS" = "FAILURE" ]; then
            # Si l'item est en pending review, c'est normal — pas une erreur
            if echo "$UPLOAD_BODY" | jq -e '.itemError[]? | select(.error_code == "ITEM_NOT_UPDATABLE")' > /dev/null 2>&1; then
              echo "⏳ Version déjà en review sur le CWS — upload ignoré"
              exit 0
            fi
            echo "❌ Upload failed"
            exit 1
          fi
          if [ "$HTTP_CODE" != "200" ]; then
            echo "❌ Upload failed (HTTP $HTTP_CODE)"
            exit 1
          fi
          echo "✅ Upload successful"
          echo "::endgroup::"

          # 3. Publier
          echo "::group::Publish extension"
          PUBLISH_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "https://www.googleapis.com/chromewebstore/v1.1/items/${CWS_EXT_ID}/publish" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "x-goog-api-version: 2" \
            -H "Content-Length: 0")
          HTTP_CODE=$(echo "$PUBLISH_RESPONSE" | tail -1)
          PUBLISH_BODY=$(echo "$PUBLISH_RESPONSE" | sed '$d')
          echo "HTTP $HTTP_CODE"
          echo "$PUBLISH_BODY" | jq . 2>/dev/null || echo "$PUBLISH_BODY"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "⚠️ Publish request returned $HTTP_CODE (may need manual review)"
          else
            echo "✅ Published"
          fi
          echo "::endgroup::"
